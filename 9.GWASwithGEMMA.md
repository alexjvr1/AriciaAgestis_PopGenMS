# GEMMA

I'll use [GEMMA](https://github.com/genetics-statistics/GEMMA/blob/master/doc/manual.pdf) to estimate the proportion of variance explained by the genetic data (PVE), and identify the most 
important loci associated with host plant choice for the A.agestis dataset. 


Gemma requires complete datasets (no missing data), hence I have to impute missing genotypes in the dataset. 


## Imputing genotypes in ddRAD dataset



## Convert genotype file to plink 

Gemma requires plink input files. However, plink doesn't recognise the chromosome names used in our reference genomes (e.g. contig_1234, and scaffold_1234). 

First rename all these regions in the vcf file: 
```
##Exctract all the chromosome names from the vcf file: 

grep "##contig=" AA261.0.5miss.9popsMerged.MAF0.05.recode.vcf > allcontigs

head allcontigs
##contig=<ID=m_scaff_1=17153>
##contig=<ID=m_scaff_2=7134>
##contig=<ID=m_scaff_3=9191>
##contig=<ID=m_scaff_4=8133>
##contig=<ID=m_scaff_5=10012>
##contig=<ID=m_scaff_6=14523>
##contig=<ID=m_scaff_7=17602>
##contig=<ID=m_scaff_8=2819>
##contig=<ID=m_scaff_9=2835>
##contig=<ID=m_scaff_10=5218>

##extract the name only and index the lines (NR). Bcftools requires old names \t new names

awk -F "=" '{print $3"\t"NR}' allcontigs > contig.names

##bcftools 
module load apps/bcftools-1.8

bcftools annotate --rename-chrs contig.names AA261.0.5miss.9popsMerged.MAF0.05.recode.vcf > AA261.forGemma.vcf

##and check that this has worked correctly: 

grep "##contig" AA261.forGemma.vcf |head
##contig=<ID=1,length=17153>
##contig=<ID=2,length=7134>
##contig=<ID=3,length=9191>
##contig=<ID=4,length=8133>
##contig=<ID=5,length=10012>
##contig=<ID=6,length=14523>
##contig=<ID=7,length=17602>
##contig=<ID=8,length=2819>
##contig=<ID=9,length=2835>
##contig=<ID=10,length=5218>

grep "##contig" AA261.forGemma.vcf |tail
##contig=<ID=93559,length=18742>
##contig=<ID=93560,length=4109>
##contig=<ID=93561,length=14916>
##contig=<ID=93562,length=14921>
##contig=<ID=93563,length=14924>
##contig=<ID=93564,length=14927>
##contig=<ID=93565,length=14926>
##contig=<ID=93566,length=14928>
##contig=<ID=93567,length=14927>
##contig=<ID=93568,length=18020>
```

This should now convert to plink with no errors: 
Check number of indivs and SNPs
```
module load apps/vcftools-0.1.12b

vcftools --vcf AA261.forGemma.vcf --plink --out AA261.forGemma.plink

VCFtools - v0.1.12b
(C) Adam Auton and Anthony Marcketta 2009

Parameters as interpreted:
	--vcf AA261.forGemma.vcf
	--out AA261.forGemma.plink
	--plink

After filtering, kept 261 out of 261 Individuals
Writing PLINK PED and MAP files ... 
Done.
After filtering, kept 18338 out of a possible 18338 Sites
Run Time = 2.00 seconds

```



## Add phenotype data 

Need a text file with three columns: family ID, indiv ID, and phenotype. See [PLINK manual](http://zzz.bwh.harvard.edu/plink/data.shtml). 

We have phenotypes for most but not all of the genotyped individuals (250/261 indivs). Maaike sent the Phenotype file on 13 June 2019 (HPPdata.xlsx). 


